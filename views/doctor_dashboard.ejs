<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>VetX</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="Favicon.ico" type="image/x-icon" rel="shortcut icon">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.12/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="css/dashboard-video-call.css">
    <link rel="stylesheet" href="css/main-dashboard.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <!--[if lt IE 9]>
    <script src="js/vendor/html5-3.6-respond-1.4.2.min.js"></script>
    <![endif]-->
</head>

<body data-spy="scroll" data-target=".navbar" data-offset="10" id="opensansclass">
    <!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
<![endif]-->
<nav id="custom-nav" class="navbar navbar-default navbar-static-top navbarorder headergradiant">
    <div class=" headercont">
        <div class="navbar-header">
            <button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" class="navbar-toggle collapsed" type="button">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="" class="navbar-brand" style="margin-right: 90px;"><span class="font18 colorwhite bold-text">   <%
                var str = clinicName;
                str = str.toLowerCase().replace(/\b[a-z]/g, function(letter) {
                return letter.toUpperCase();
            });
            %>
            <%= str %></span></a>
        </div>
        <div class="navbar-collapse collapse" id="navbar" aria-expanded="false">

            <ul class="nav navbar-nav pull-right">
                <!--  <li><a><i class="fa fa-bell-o"></i></a></li> -->
                <li>
                    <!-- <a href="dashboard-table.html" style="padding: 0px;"> <img class="media-object img-circle dropdown-toggle" type="button" data-toggle="dropdown" data-src="holder.js/64x64" alt="64x64" style="width: 35px; height: 35px;" src="img/userprofile.png"><span class="caret"></span></a> -->
                    <div class="dropdown">
                        <button class="dropdown-toggle" type="button" data-toggle="dropdown"><img src="<%= doctorInfo.profileImage  %>" class="pro-img">
                            <span class="caret"></span></button>
                            <ul class="dropdown-menu">
                                <li><a href="#" data-toggle="modal" data-target="#edit-profile"><i class="fa fa-sign-out" aria-hidden="true"></i> Edit Profile</a></li>
                                <li><a href="/doctor/logout"><i class="fa fa-sign-out" aria-hidden="true"></i> Logout</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>
    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
        <div class="container">
            <div class="row">
                <div class="conversation-wrap petsView minheightdash col-lg-3">
                    <div class="media conversation bgwhite">
                        <div class="media-body media-body">
                            <h6 class="media-heading bold-text">VETS'S</h6>
                        </div>
                    </div>
                    <!-- available -->



                    <% for(var i=0;i<docInfo.length;i++) { %>

                    <div class="media conversation conversation-avail bgwhite">
                        <a class="pull-left" href="#">
                            <!-- <i class="fa fa-circle colorgreen chat-check online"></i> -->
                            <img class="media-object img-circle" data-src="holder.js/64x64" alt="64x64" style="width: 40px; height: 40px;" src="<%= docInfo[i].profileImage %>">
                        </a>
                        <div class="media-body-custom top">
                            <h5 class="media-heading bold-text"><%= docInfo[i].name %>
                                <%
                                if(docInfo[i].callStatus == "available" && docInfo[i].loggedIn == true)
                                {
                                %>

                                <span class="avail">Available</span>
                                <%
                            }
                            else if(docInfo[i].callStatus == "busy")
                            {
                            %>
                            <span class="busy">Busy</span>
                            <%
                        }
                        else
                        {
                        %>
                        <span class="offline">Offline</span>

                        <% } %>

                    </h5>
                    <small>From <%= docInfo[i].name %></small>
                </div>
            </div>
            <% } %>

            <!-- busy -->
        <!--        <div class="media conversation conversation-avail bgwhite">
        <a class="pull-left" href="#">
        <i class="fa fa-circle colororange chat-check online"></i>
        <img class="media-object img-circle" data-src="holder.js/64x64" alt="64x64" style="width: 40px; height: 40px;" src="img/userprofile.png">
        </a>
        <div class="media-body-custom top">
        <h5 class="media-heading bold-text">Rachel Chandter <span class="busy">Busy</span></h5>
        <small>Director of veterinary Affairs</small>
        </div>
    </div> -->
    <!-- offline -->
        <!--      <div class="media conversation conversation-avail bgwhite">
        <a class="pull-left" href="#">
        <i class="fa fa-circle colorred chat-check online"></i>
        <img class="media-object img-circle" data-src="holder.js/64x64" alt="64x64" style="width: 40px; height: 40px;" src="img/userprofile.png">
        </a>
        <div class="media-body-custom top">
        <h5 class="media-heading bold-text">Rachel Chandter <span class="offline">Offline</span></h5>
        <small>Director of veterinary Affairs</small>
        </div>
    </div> -->


</div>
<div class="message-wrap col-lg-9 firstsectiondash">
    <div class="col-md-12 col-sm-12">
        <h1 class="head-text">History</h1>
        <% if(callHistory.length ==0)
        {
        %>
        <div class="col-md-10 col-md-offset-1">
            <div class="box-empty">
                <img src="img/empty-cat.png" class="img-responsive center-block">
                <label class="box-label1 center">Lorem Ipsum is simply dummy text of the printing and typesetting industry</label>
                <label class="box-header center">Phasellus commodo, metusnon</label>
            </div>
        </div>
        <% } else {%>
        <div class="table-div">
            <table id="history" class="hover" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>User Name</th>
                        <th>User ID</th>
                        <th>Pet ID</th>
                        <th>Consulting ID</th>
                        <th>Date/Time</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <% for(var i=0;i<callHistory.length;i++) { %>
                    <tr>
                        <td><%= i+1 %>.</td>
                        <td><img class="img-circle table-img-size" 
                            src="<%= callHistory[i].userId.profilePic %>"> <%= callHistory[i].userId.lastName %></td>
                            <td>USER-<%= callHistory[i].userId._id.toString().slice(-5); %></td>
                            <td>PET-<%= callHistory[i].petId._id.toString().slice(-5); %></td>
                            <td>CON-<%= callHistory[i]._id.toString().slice(-5); %></td>
                            <td><%= callHistory[i].callAccepted %></td>
                            <td>
                                <button class="btn colorwhite bgorange buttonpad-orange padingbuttonView Report collapsed" data-toggle="modal" data-target="#report" type="button" aria-expanded="false" onclick="viewReport('<%= callHistory[i].summary %>','<%= callHistory[i].amt %>')">View Report</button>
                            </td>
                        </tr>

                        <% } %>
                    </tbody>
                </table>
            </div>
            <% } %>

        </div>
    </div>
</div>
</div>
</div>

<!--******************popup for call **************************-->
<div id="report" class="modal fade-scale" role="dialog">
   <div class="modal-dialog">
       <!-- Modal content-->
       <div class="modal-content">
           <div class="modal-header">
               <h4 class="modal-title">View Report</h4>
           </div>
           <div class="modal-body">
               <h1>Summary</h1>
               <p ><span id="reportSummary" ></span>
                   <span class="fees">Consulting Fee $ <span id="reportAmt"></span></span></p>
               </div>
               <div class="modal-footer">
                   <button class="btn colorwhite bgorange buttonpad-orange padingbuttonView Report collapsed" data-dismiss="modal">OK</button>
               </div>
           </div>
       </div>
   </div>
   <!--*****************popup for call end **********************-->

   <!--******************popup for call **************************-->
   <div id="call" class="modal fade-scale" role="dialog" data-backdrop="static" >
       <div class="modal-dialog">
           <!-- Modal content-->
           <div class="modal-content">
               <div class="modal-header">
                   <h4 class="modal-title">Incoming Call</h4>
               </div>
               <div class="modal-body">
                   <div class="calling-img">
                       <img src="img/profile_user.jpg" class="img-responsive" id="IncomingUserImage">
                   </div>
                   <h1><span id="callUserName"></span>  is calling...</h1>
               </div>

               <div class="modal-footer">
                   <button id="callAccept" class="btn btn-default accept" >Accept
                   </button>
                   <!--  <button id="callAccept" class="btn btn-default accept" >Accept</button> -->
                   <button type="button" 
                   class="btn btn-default reject" 
                   data-dismiss="modal" id="callReject">Reject</button>
               </div>
           </div>
       </div>
   </div>
   <!--*****************popup for call end **********************-->
   <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
   <script>
    window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')
</script>
<script src="js/vendor/bootstrap.min.js"></script>
<script src="js/vendor/css3-animate-it.js"></script>
<script src="js/main.js"></script>
<script src="//media.twiliocdn.com/sdk/js/common/v0.1/twilio-common.min.js"></script>
<script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script src="//media.twiliocdn.com/sdk/js/video/releases/1.0.0-beta2/twilio-video.js"></script>
<script type="text/javascript" src="js/quickstart.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
<script>
    $(document).ready(function() {

        $('#history').DataTable();
    });

   // var socket = io.connect('http://localhost:3330');
                //var socket = io.connect('http://35.164.220.7:3330');
               // var socket = io.connect('https://vetx.herokuapp.com');
               //var socket = io.connect('https://vetxb2c.herokuapp.com'); 
               var socket = io.connect('https://www.vetxapp.com');     

               


    //CALL ACTION MODEULES 

    socket.on("call_action_<%= doctorInfo._id %>", function(info) {

        var callUserId=info.callActionInfo.userInfo.callUserId;
        var clinicId=info.callActionInfo.userInfo.clinicId;
        var petId=info.callActionInfo.userInfo.petId;
        var userImage=info.callActionInfo.userInfo.userImage;
        var userName=info.callActionInfo.userInfo.userName;
        var doctorId=info.callActionInfo.doctorInfo[0]._id;
        $("#callUserName").text(userName);
        $("#IncomingUserImage").attr("src", userImage);

        $("#play_<%= doctorInfo._id %>").trigger("click");

        $('#call').modal();


        var audionFiles= '<audio controls autoplay><source src="horse.ogg" type="audio/ogg"><source src="horse.mp3" type="audio/mpeg"> </audio>';

            //CALL REJECT BY  DOCTOR

            var doctor_accept_info={"accept_status":0,"user_id":callUserId,"petId":petId,
            "clinicId":clinicId};

            $("#callReject").click(function() {

                $("#pause_<%= doctorInfo._id %>").trigger("click");
                socket.emit('accept_status',doctor_accept_info, function(data){
                });
            });

            //CALL ACCEPT BY  DOCTOR
            $("#callAccept").click(function() {

                $('#call').modal('hide');
                $("#pause_<%= doctorInfo._id %>").trigger("click");

                popupWindow = window.open(
                    "/doctor/doctorVideoCall?p="+petId+"&q="+clinicId+"&r="+callUserId+"&s="+doctorId+"",'popUpWindow','height=500,width=700,left=10,top=10,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no,status=yes');
            });



        });


    socket.on("startCallHistory", function(info) {

        $("#consultingId").text("CON-"+info.info.callHistory._id.toString().slice(-5));
        $("#consultingUserId").text("USER-"+info.info.callHistory.userId._id.toString().slice(-5));
        $("#consultingUserName").text(info.info.callHistory.userId.firstName);
        $("#consultingPetId").text("PET-"+info.info.callHistory._id.toString().slice(-5));
        $("#consultingCallAccepted").text(info.info.callHistory.callAccepted);
        $("#callId").val(info.info.callHistory._id);

    });

        //CALL END STATUS 

        socket.on("callEndStatusInfo_<%= doctorInfo._id %>", function(info) {
         $('#endButton').modal();
     });

     //QUICK CALL END STATUS 

     socket.on("quickCallcutDoctorInfo_<%= doctorInfo._id %>", function(info) {

         //$('#endButton').modal(); ///YET TO STARTS 
         $('#call').modal('hide');
         $("#pause_<%= doctorInfo._id %>").trigger("click");
     });


     //END CALL ACTION

     $(document).ready(function() {
      $(".firstsectiondash").show();
      $(".sectionsectiondash").hide();

  });
     $(document).ready(function() {
        $("#historydash").click(function() {
            $(".firstsectiondash").hide();
            $(".sectionsectiondash").show();
        });
        $("#ongoingdash").click(function() {
            $(".firstsectiondash").show();
            $(".sectionsectiondash").hide();
        });
        $("#back2").click(function() {
            $(".firstsectionbuy").show();
            $(".sectionsectionbuy").hide();
        });
        $("#next2").click(function() {
            $(".sectionsectionbuy").hide();
            $(".thirdsectionbuy").show();
        });
        $("#next3").click(function() {
            $(".thirdsectionbuy").hide();
            $(".fourthsectionbuy").show();
        });
        $("#next4").click(function() {
            $(".fourthsectionbuy").hide();
            $(".fifthsectionbuy").show();
        });

    });
 </script>
 <!--<script>-->
 <!--$('#endButton').modal('hide');-->
 <!--$('body').removeClass('modal-open');-->
 <!--$('.modal-backdrop').remove();-->
 <!---->
 <!--</script>-->
 <script>
    (function(b, o, i, l, e, r) {
        b.GoogleAnalyticsObject = l;
        b[l] || (b[l] =
            function() {
                (b[l].q = b[l].q || []).push(arguments)
            });
        b[l].l = +new Date;
        e = o.createElement(i);
        r = o.getElementsByTagName(i)[0];
        e.src = 'http://www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e, r)
    }(window, document, 'script', 'ga'));
    ga('create', 'UA-XXXXX-X', 'auto');
    ga('send', 'pageview');
</script>
<script>
    $(window).scroll(function() {
        if ($(".navbar").offset().top > 50) {
            $('#custom-nav').addClass('affix');
            $(".navbar-fixed-top").addClass("top-nav-collapse");
        } else {
            $('#custom-nav').removeClass('affix');
            $(".navbar-fixed-top").removeClass("top-nav-collapse");
        }
    });
</script>
<script>
    document.getElementById('searchtext').value = 'Search the doctor or the message';
</script>
<script src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.12.0/jquery.validate.min.js"></script>
<script>
    $('.panel-heading a').click(function() {
        $('.panel-heading').removeClass('actives');
        $(this).parents('.panel-heading').addClass('actives');

        $('.panel-title').removeClass('actives'); //just to make a visual sense
        $(this).parent().addClass('actives'); //just to make a visual sense

    });

    //VIEW REPORT 

    function viewReport(summary,amt)
    {

        $("#reportAmt").text(amt);
        $("#reportSummary").text(summary);
    }


    $(function() {
      // Initialize form validation on the registration form.
      // It has the name attribute "registration"
      $("form[name='callEnd']").validate({
        // Specify validation rules
        rules: {
          consultingSummary: {
            required: true
        },
        consultingPrice: {
            required: true,
            number: true

        }
    },
    // Specify validation error messages
    messages: {
        consultingSummary: "Please provide summary *",
        consultingPrice: "Please provide amount *"
    },
    // Make sure the form is submitted to the destination defined
    // in the "action" attribute of the form when valid
    submitHandler: function(form) {
       updateCallEnd();
   }
});
  });

    function updateCallEnd()
    {

      var callId=$('#callId').val();

      var new_form = new FormData($('#callEnd')[0]);
      $.ajax({
        type: 'PUT',
        url:  "/doctor/callEnd/"+callId,
        data: $('#callEnd').serialize(),
        statusCode: {
          200: function (response) {
           alert('success');
           location.reload();
       },500: function (response) {
         alert('failure');
     }},
     mimeType: "multipart/form-data"
 });


  }



</script>


<!-- site loading -->
<div id="endButton" class="modal fade" data-keyboard="false" data-backdrop="static" role="dialog">
  <div class="modal-dialog">
      <!-- Modal content-->
      <div class="modal-content">

          <form method="post"  id="callEnd" name="callEnd"  enctype="multipart/form-data">

              <div class="modal-header">
                  <h4 class="modal-title">Thank you for the video call</h4>
              </div>
              <div class="modal-body">
                  <p class="bold-text col-md-8">Consulting ID:<span id="consultingId"></span></p>
                  <p class="pull-right colorgray col-md-offset-1 col-md-3 textalignright" 
                  id="consultingCallAccepted"> 19/09/2016</p>
                  <br>
                  <p class="colorgray col-md-8">User ID:<span id="consultingUserId"></span></p>
                  <!--   <p class="pull-right colorgray col-md-offset-1 col-md-3 textalignright "> 01:20 PM</p> -->
                  <br>
                  <p class="bold-text col-md-12">User Name: <span id="consultingUserName"></span></p>
                  <br>
                  <p class="colorgray col-md-12">Pet ID: <span id="consultingPetId"></span></p>
                  <br>
                  <p class="bold-text col-md-12">Summary</p>
                  <br>
                  <br>
                  <textarea rows="4" placeholder="Write Summary" class="bglitegray colorlitegray form-control modaltextbox" id="consultingSummary" name="consultingSummary"></textarea>
                  <input type="hidden" name="callId" id="callId" name="callId">
                  <br>
                  <p style="margin-top: 7px;" class="bold-text col-md-4">Consulting Fee: $</p>
                  <div class="col-md-5" style="margin-left: -8px;">
                      <input type="text" style="border-width: 0px; margin-left: -32%;" class="bglitegray colorgray form-control" placeholder="enter amount" 
                      id="consultingPrice" name="consultingPrice">
                  </div>
              </div>
              <br>
              <br>
              <div style="margin-top: 7px;" class="modal-footer">
                  <button  class="btn colorwhite bgorange buttonpad-orange" type="Sumit">Submit</button>
              </div>

          </form>
      </div>
  </div>
</div>

<!-- Edit Profile Modal -->

<!-- Modal -->
<div id="edit-profile" class="modal fade" role="dialog" data-backdrop="static"> 
  <div class="modal-dialog">
      <form method="post"  id="userEdit" name="userEdit" enctype="multipart/form-data" >
          <!-- Modal content-->
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                  <h4 class="modal-title">Edit Profile</h4>
              </div>
              <div class="modal-body">

                  <div class="col-md-12">
                      <div class="image-upload col-md-offset-5">
                          <label for="vetUserImage">
                              <img id="vetUserImageSrc" src="<%= doctorInfo.profileImage  %>" alt="your image" height="100">
                          </label>
                          <input id="vetUserImage" type="file">
                      </div>


                      <div class="form-group">
                          <label for="usr">Name</label>
                          <input type="text" class="buy-input" name="name" value="<%= doctorInfo.name  %>">
                      </div>
                      <div class="form-group">
                          <label for="usr">Email ID</label>
                          <input type="text" class="buy-input" name="email" value="<%=  doctorInfo.email %>" readonly>
                          <input type="hidden" name="userId" id="userId" value="<%=  doctorInfo._id  %>" >
                      </div>
                      <div class="form-group">
                          <label for="pwd">Password</label>
                          <input type="password" class=" buy-input" name="password" 
                          value="<%= doctorInfo.password %>">
                      </div>
                  </div>
              </div>


              <div class="modal-footer">
                  <button type="submit" class="whiteHomeButton" >Submit</button>
              </div>
          </div>

      </form>


  </div>
</div>



</body>

<script type="text/javascript">


  $(function() {
  // Initialize form validation on the registration form.
  // It has the name attribute "registration"
  $("form[name='userEdit']").validate({
    // Specify validation rules
    rules: {
      name: {
        required: true
    }

},
    // Specify validation error messages
    messages: {
    //   password: {
    //     required: "Please provide a password *",
    //     minlength: "Your password must be at least 5 characters long *"
    // },
    // email: "Please enter a valid email address *",
    firstName: "Please provide firstname *",
    lastName: "Please provide lastname *",


},
    // Make sure the form is submitted to the destination defined
    // in the "action" attribute of the form when valid
    submitHandler: function(form) {
       userUpdate();
   }
});
});

    //USER PROFILE UPDATE

    function userUpdate()
    {

        var userId=$("#userId").val();
        var urlValue="/doctor/doctorProfileUpdate/"+userId;
        var new_form = new FormData($('#userEdit')[0]);
        $.ajax({
          url: urlValue,
          type: 'PUT',
          data: new_form,
          statusCode: {
              200: function (response) {
               alert('success');
               location.reload();
           },500: function (response) {
             alert('failure');

         }},
         cache: false,
         contentType: false,
         mimeType: "multipart/form-data",
         processData: false
     });
    } 


    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function(e) {
                $('#vetUserImageSrc').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    $("#vetUserImage").change(function() { 

        readURL(this);
    });


 //***********FOR RINGING WHEN USER CALLING ***************//

 $(document).ready(function() {

    var audioElement = document.createElement('audio');
    audioElement.setAttribute('src', 'uploads/cat.mp3');
    
    audioElement.addEventListener('ended', function() {
        this.play();
    }, false);
    
    audioElement.addEventListener("canplay",function(){
        $("#length").text("Duration:" + audioElement.duration + " seconds");
        $("#source").text("Source:" + audioElement.src);
        $("#status").text("Status: Ready to play").css("color","green");
    });
    
    audioElement.addEventListener("timeupdate",function(){
        $("#currentTime").text("Current second:" + audioElement.currentTime);
    });
    
    $('#play_<%= doctorInfo._id %>').click(function() {
        audioElement.play();
        $("#status").text("Status: Playing");
    });
    
    $('#pause_<%= doctorInfo._id %>').click(function() {
        audioElement.pause();
        $("#status").text("Status: Paused");
    });
    
    $('#restart_<%= doctorInfo._id %>').click(function() {
        audioElement.currentTime = 0;
    });
});
 
 //***********FOR RINGING WHEN USER CALLING ***************//

</script>

<div style="display:none">

    <div id="length"></div>
    <div id="source"></div>
    <div id="status"></div>
    <hr>
    <h2></h2>
    <button id="play_<%= doctorInfo._id %>"></button>
    <button id="pause_<%= doctorInfo._id %>"></button>
    <button id="restart_<%= doctorInfo._id %>"></button>
    <hr>
    <div id="currentTime"></div>
</div>

</html>
